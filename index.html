<html>

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <style>
        @font-face {
            font-family: 'Fira Sans';
            src: local('FiraSans-Regular'), url('https://interactive-examples.mdn.mozilla.net/media/fonts/FiraSans-Regular.woff2') format('woff2');
            font-weight: 400;
            font-style: normal
        }

        body {
            font-size: 1.5em;
            font-variant-numeric: tabular-nums;
            font-family: 'Fira Sans', sans-serif;
            padding: 10px 20px;
            user-select: none;
        }

        /* * {
            box-sizing: border-box;
        } */

        .title {
            display: inline-block;
            width: 20vw;
        }

        .data {
            margin-top: 1em;
        }

        .data p {
            padding-bottom: 0.1em;
            border-bottom: 1px solid black;
        }

        #btn {
            width: 8em;
            /* padding: 10px 40px; */
            align-self: center;
            /* background-image: url("https://icons.getbootstrap.com/assets/icons/play.svg"); */
        }

        #btn[playing=true] {
            background-color: red;
            border-color: pink;
        }

        main {
            margin-top: 1em;
            display: flex;
            flex-direction: column;
            /* justify-content: center; */
        }

        #log {
            flex-grow: 1;
        }
    </style>

    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
        integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
        crossorigin="anonymous"></script>

</head>

<main x-data>
    <button type="button" class="btn btn-primary shadow-none" id="btn">
        Play</button>

    <div class="data">
        <p>
            <span class="title">Estimate Diff</span>
            <span class="title" x-text="$store.statistic.estimate_time_diff"></span>
        </p>
        <p><span class="title">Delay</span>
            <span class="title" x-text="$store.statistic.delay"></span>
        </p>
        <p><span class="title">Remains</span>
            <span class="title" x-text="$store.statistic.remain"></span>
        </p>
    </div>
    <div>
        <details>
            <summary>Log</summary>
            <div x-show="false" id="_log">
        </details>
    </div>
    </div>
</main>

<script type="text/javascript" charset="utf-8">

    document.addEventListener('alpine:init', () => {
        Alpine.store('darkMode', {
            on: false,

            toggle() {
                this.on = !this.on
            }
        });

        Alpine.store('statistic', {
            estimate_time_diff: 0,
            delay: 0,
            remain: 0,

            setDiff(diff) {
                this.estimate_time_diff = diff;
            },
            setDelay(delay) {
                this.delay = delay;
            },
            setRemain(remain) {
                this.remain = remain;
            },
        });

        main();
    })

    function log(message) {
        const _reserve = (s, digits) => {
            return `${s}`.length >= digits ? s :
                _reserve(`${s}0`, digits - 1);
        }
        let date = new Date();
        let date_string = `${_reserve(date.getHours(), 2)}:${_reserve(date.getMinutes(), 2)}:${_reserve(date.getSeconds(), 2)}:${_reserve(date.getMilliseconds(), 3)}`;
        _log.innerHTML = `${date_string} ${message}<br/>` + _log.innerHTML.slice(0, 2000)
    }

    function main() {
        log("Main");

        let context;
        let soundSource;

        let socket = io();

        let time_a = Date.now();
        // NOTE: diff = BrowserTime - RemoteTime
        let diff = 0;
        socket.on('time', function (message) {
            let time_b = Date.now();
            let time_remote = message.time;
            diff = (time_a + time_b) / 2000 - time_remote;
            log(`Diff ${diff}s`);
            Alpine.store("statistic").setDiff(diff);
        })
        socket.emit("time", null);

        socket.on('listen!', function (message) {
            createSoundSource([new Float32Array(message.data)], message.time, message.index);
        });

        let allow_play = false;

        let play = false;

        let next_time = 0;

        btn.onclick = () => {
            if (play) {
                log("Stop")
                btn.innerText = "Play"
                btn.setAttribute("playing", false)
                context = null;
                next_time = 0;
            } else {
                btn.innerText = "Stop"
                log("Start")
                btn.setAttribute("playing", true)
                context = new AudioContext({
                    numberOfChannels: 2,
                    sampleRate: 44100
                });
            }
            play = !play;
        }

        // Web Audio streaming with fetch API
        // https://gist.github.com/revolunet/e620e2c532b7144c62768a36b8b96da2
        function createSoundSource(audioData, time, index) {
            if (!context) return;

            for (var i = 0; i < audioData.length; i++) {
                let channel_len = audioData[i].length / 2;
                let duration = channel_len / 44100;
                let c1 = audioData[i].slice(0, channel_len);
                let c2 = audioData[i].slice(channel_len);

                audioCtx = context;
                var myArrayBuffer = audioCtx.createBuffer(2, channel_len, audioCtx.sampleRate);
                myArrayBuffer.copyToChannel(c1, 0);
                myArrayBuffer.copyToChannel(c2, 1);

                var source = audioCtx.createBufferSource();
                source.buffer = myArrayBuffer;
                source.connect(audioCtx.destination);

                if (next_time == 0) {
                    // 0.5 controls delay.
                    next_time = context.currentTime + 0.5;
                }

                source.start(next_time);
                next_time += duration;

                let delay = next_time - context.currentTime + Date.now() / 1000.0 - (time + diff);
                let remain = next_time - context.currentTime;
                log(`Delay ${delay}s`);
                log(`Remains ${remain}s`);
                Alpine.store("statistic").setDelay(delay);
                Alpine.store("statistic").setRemain(remain);
            }
        }
    }
</script>

</html>